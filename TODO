make the test env be able to handle sending messages without sleep
implement the algorithm in a library
